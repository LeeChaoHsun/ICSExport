# ICSExport软件维护手册

## 1 函数列表

### 1.B 启动阶段

#### 1.B.1 void readArguments(int argc, const char *argv[])

从参数列表中读取并分离参数，调用相关函数以设定标志位和有关变量。

| 参数 | 作用                                     |
| ---- | ---------------------------------------- |
| argc | 传入主函数的argc，用于指定参数个数       |
| argv | 传入主函数的argv，存放指向各个参数的指针 |

#### 1.B.2 void argumentTranslator(const char *arg)

处理由readArguments分离的参数并设定相关标志位。

| 参数 | 作用                            |
| ---- | ------------------------------- |
| arg  | 由readArguments分离的参数字符串 |

#### 1.B.3 void filenameReader(const char *arg)

读入参数作为输入或输出文件名。

| 参数 | 作用                        |
| ---- | --------------------------- |
| arg  | 由readArguments分离的文件名 |

#### 1.B.4 void argFlagDealer()

处理argFlag中的标志位。

### 1.C 时钟与随机数

#### 1.C.1 void genGmStamp(char *stamp)

生成字符串格式的时间（采用UTC时间）戳并存入stamp。

### 1.D 日期操作

#### 1.D.1 void evalFirstMonday(int weekcnt, const char* monOfThis)

计算第一周的周一日期并存入firstMonday。

| 参数      | 作用           |
| --------- | -------------- |
| weekcnt   | 这周的周数     |
| monOfThis | 这周周一的日期 |

#### 1.D.2 void nextDay(const char* now, char *next)

计算now表示的日期的下一天并存入next，yyyyMMdd。

函数不会检查日期是否合法。

| 参数 | 作用                       |
| ---- | -------------------------- |
| now  | 这一天的日期               |
| next | 下一天的日期要被存入的位置 |

#### 1.D.3 void lastDay(const char* now, char *last)

计算now表示的日期的上一天并存入last，yyyyMMdd。

函数不会检查日期是否合法。

| 参数 | 作用                       |
| ---- | -------------------------- |
| now  | 这一天的日期               |
| last | 上一天的日期要被存入的位置 |

#### 1.D.4 int isLeapYear(int now)

判断是否为闰年。

| 参数 | 作用     |
| ---- | -------- |
| now  | 当前年份 |

**返回值** 若是闰年则返回1，反之返回0。

#### 1.D.5 void nextWeek(const char* now, char *next)

返回now的七天后的日期。

| 参数 | 作用                     |
| ---- | ------------------------ |
| now  | 这一天的日期             |
| next | 七天后的日期要存入的位置 |

#### 1.D.6 void lastWeek(const char* now, char *last)

计算now的七天前的日期。

| 参数 | 作用                     |
| ---- | ------------------------ |
| now  | 这一天的日期             |
| last | 七天前的日期要存入的位置 |

### 1.F 文件操作

#### 1.F.1 void openScript()

打开脚本。

#### 1.F.2 void fileFlagDealer()

处理fileFlag中的标志位。

#### 1.F.3 void closeScript()

关闭脚本。

#### 1.F.4 void readLine()

从脚本中读取一行并存入lbuf。若已到文件末尾，则置SEOF为真。

#### 1.F.5 void readNextUnemptyLine()

从脚本中读取下一个非空行，存入lbuf。

#### 1.F.6 void readNextUnannoedUnemptyLine()

读取下一个非注释的非空行，存入lbuf。

### 1.O 杂项

#### 1.O.1 void putUsage()

打印说明文本。

### 1.P 内容处理

#### 1.P.1 void readHead()

读取脚本的头部并设定相关变量。

#### 1.P.2 void freeMem()

释放内存。

## 2 变量(常量)列表

### 2.C 常量

#### 2.C.1 NAME_MAX

文件名的最大长度。

#### 2.C.2 PRINT_HELP

指示需要打印帮助文本。

#### 2.C.3 ABORT

指示在某个步骤后程序无法继续执行，详见2.F.1和2.F.2中的说明。

#### 2.C.4 UNDEFINED_ARG

指示存在未知的参数。

#### 2.C.5 TOO_MANY_FILENAMES

指示用户传入了多于两个的文件名。

#### 2.C.6 ONE_FILENAME

指示用户只传入了一个文件名。

#### 2.C.7 LINE_MAX

用户脚本一行的最大长度。

#### 2.C.8 OPEN_ERROR

指示打开文件时发生错误（fopen返回NULL）。

#### 2.C.9 UID_LENGTH

VEVENT唯一标识符的长度。

#### 2.C.10 LOC_MAX

VEVENT LOCATION的最大长度。

#### 2.C.11 SUMMARY_MAX

VEVENT SUMMARY的最大长度。

#### 2.C.12 DES_MAX

VEVENT DESCRIPTION的最大长度。

#### 2.C.13 SEOF

指示脚本文件已经读取完毕。

#### 2.C.14 TIMEZONE

当地时间超前UTC时间的秒数。

### 2.F 标志位

#### 2.F.1 argFlag

与读取参数有关的标志位。

| 标志位符号         | 作用                                   |
| ------------------ | -------------------------------------- |
| PRINT_HELP         | 指示需要打印帮助文本                   |
| ABORT              | 指示未读取到有效内容，程序无法继续执行 |
| UNDEFINED_ARG      | 存在未知参数                           |
| TOO_MANY_FILENAMES | 指示用户传入了多于两个的文件名         |
| ONE_FILENAME       | 指示用户只传入了一个文件名             |

#### 2.F.2 fileFlag

与读写文件有关的标志位。

| 标志位符号 | 作用                                |
| ---------- | ----------------------------------- |
| ABORT      | 文件操作发生错误，程序无法继续执行  |
| OPEN_ERROR | 打开文件时发生错误（fopen返回NULL） |
| SEOF       | 脚本文件已经读取完毕                |

### 2.O 杂项

#### 2.O.1 numOfClasses

一天的课数。

### 2.P 文件相关

#### 2.P.1 src

脚本文件指针

#### 2.P.2 dest

目标.ics文件指针

### 2.S 字符串

#### 2.S.1 infileName

脚本文件的文件名。

#### 2.S.2 outfileName

待输出的iCalendar文件名。

#### 2.S.3 firstMonday

第一周的周一日期，yyyyMMdd。

#### 2.S.4 lbuf

读取脚本的行缓冲区。

### 2.T 结构体数据

#### 2.T.1 clses

存储课时。

结束时需要用free()释放。

## 3 数据类型

### 3.1 VEVENT

定义一个事件。

#### 3.1.1 内容

| 成员                          | 解释                                         |
| ----------------------------- | -------------------------------------------- |
| char DTSTAMP[17]              | Event创建的时间戳yyyyMMddTHHmmssZ（UTC时间） |
| char UID[UID_LENGTH + 1]      | Event的唯一标识符                            |
| char DTEND[16]                | 终止日期yyyyMMdd                             |
| char DTSTART[16]              | 起始日期yyyyMMdd                             |
| int isRec                     | 该事件是否循环                               |
| int recCount                  | 循环次数                                     |
| char LOCATION[LOC_MAX + 1]    | 事件地点                                     |
| char DESCRIPTION[DES_MAX + 1] | 事件描述                                     |

## 3.2 CNUM

定义一节课的时间。

| 成员           | 解释           |
| -------------- | -------------- |
| char CBEGIN[7] | 开始时间HHmmss |
| char CEND[7]   | 结束时间HHmmss |

